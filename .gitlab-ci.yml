image: docker:latest
services:
    - docker:dind

stages:
    - build
    # - test
    - deploy

before_script:
    # установка pip
    - apk add --no-cache py-pip
    # установка docker-compose
    - pip install docker-compose==1.9.0
    # логин в Gitlab Docker registry
    - docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN $CI_REGISTRY

build:
    stage: build
    script:
        # собственно сборка
        - docker-compose build
        # отправка собранного в registry
        - docker-compose push

# test:
#     stage: test
#     script:
#         # вместо повторной сборки, забираем собранный на предыдущей ступени
#         #  готовый образ из registry
#         - docker-compose pull test
#         # запускаем тесты
#         - docker-compose run test

deploy:
    stage: deploy
    # выкатываем только ветку master
    only:
        - main
    # для этой ступени другие команды инициализации
    script:
        - fab -H $DEPLOY_ADDR deploy
